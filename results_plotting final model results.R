

#' The purpose of this script is to read and plot the test set results
#' that were generated by each of the predictive models that we tested.
#' two main figures and two subfigures will be produced. The main figure
#' will show each model that was tested on the vertical axis and the corre-
#' sponding error metric values on the horizontal axis. Model order will be:
#' 1) SVR
#' 2) LGBM
#' 3) Catboost
#' 4) XGB
#' 5) Prophet
#' 6) Stacked
#' 


# loading libraries
library(tidyverse)
library(magrittr)
library(shades)

# plotting theme

theme_ai <- function(){
  theme_minimal() +
    theme(
      text = element_text(color = "gray25"),
      plot.title = element_text(size=26),
      plot.subtitle = element_text(size = 24),
      axis.title = element_text(size = 18),
      axis.text = element_text(size=18),
      plot.caption = element_text(color = "gray30", size=12),
      plot.background = element_rect(fill = "white"),
      plot.margin = unit(c(5, 10, 5, 10), units = "mm"),
      axis.line = element_line(color="gray85"),
      axis.ticks.x = element_line(color="gray65"),
      panel.grid.major.y = element_line(colour = "gray80"),
      #panel.grid.major.y = element_blank(),
      panel.grid.minor.x =  element_blank(),
      panel.grid.major.x =  element_line(color="gray80")
    )
}


###############################################
# Creating a MAPE summary test set results plot
###############################################

# reading results data into R
test_results_df <- 
  read_csv("Data/final_testset_results_2020-08-11.csv") %>%
  select(building_id_kaggle:mape_mlp)

# reading building metadata into R
building_metadata_df <- 
  read_csv("Data/building_metadata_final_2020-06-24.csv")

#######################
# Results by model type
#######################

# calculating medians and percentiles 

median_test_results <- 
  test_results_df %>%
  summarise(across(rmse_svr:mape_mlp,median))%>%
  gather(key = metric_type, value = median_value) %>%
  mutate(metric_type = as.factor(metric_type))

perc_25_test_results <-
  test_results_df %>%
  summarise(across(rmse_svr:mape_mlp,quantile,.25))%>%
  gather(key = metric_type, value = perc_25_value) %>%
  mutate(metric_type = as.factor(metric_type))

perc_75_test_results <- 
  test_results_df %>%
  summarise(across(rmse_svr:mape_mlp,quantile,.75)) %>%
  gather(key = metric_type, value = perc_75_value) %>%
  mutate(metric_type = as.factor(metric_type))

summary_results <- 
  median_test_results %>%
  left_join(perc_25_test_results) %>%
  left_join(perc_75_test_results)

# formatting test_results dataframe so that it is easier to work 
# with in ggplot

test_results_wide_df <-
  test_results_df %>%
  gather(-building_id_kaggle,key = metric_type, value = metric_value) %>%
  mutate(metric_type = as.factor(metric_type))

# joining test results dataframe with building metadata

test_results_wide_df <- 
  left_join(test_results_wide_df,
            building_metadata_df)

# how to capture specific error metrics

mape_test <- 
  test_results_wide_df[grepl(test_results_wide_df$metric_type,pattern = "mape"),] %>%
  mutate(model_type = str_remove(metric_type,"mape_"))

mape_test <- 
  mape_test %>%
  mutate(model_type = ifelse(model_type == "mlp", "FFNN",model_type))

mape_summary_test <- 
  summary_results[grepl(summary_results$metric_type,pattern = "mape"),] %>%
  mutate(model_type =str_remove(metric_type,"mape_"))

mape_summary_test <- 
  mape_summary_test %>%
  mutate(model_type = ifelse(model_type == "mlp", "FFNN",model_type))

mape_test$model_type <- as.factor(toupper(x = mape_test$model_type))

mape_summary_test$model_type <- as.factor(toupper(x = mape_summary_test$model_type))




mape_summary_plt <- 
  ggplot()+
  geom_jitter(data = mape_test, aes(x = reorder(model_type, desc(model_type))
                                    , y = metric_value), 
              alpha = 0.4, colour='#A4A4A4')+
  geom_point(data = mape_summary_test, aes(x = reorder(model_type, desc(model_type)), 
                                                       y  = median_value ), size = 3.5)+
  geom_errorbar(data = mape_summary_test, aes(x = reorder(model_type, desc(model_type)),
                                                   ymin = perc_25_value,
                                                   ymax = perc_75_value), width = 0.25, size = 1.5 )+
  geom_text(data = mape_summary_test, 
            aes(x = model_type, y  =median_value, label = round(median_value,1)),
            size = 6.5,
            nudge_x = .3)+
  # annotate("point", x = 13, y = 170,
  #          colour = "black", size = 3)+
  # annotate("text", x = 13, y = 180, 
  #          colour = "black", size = 7, label = 'Median')+ # median 
  # annotate("point", x = 12.5, y = 170,
  #          colour = "#0BA2DB", size = 3)+
  # annotate("text", x = 12.5, y = 187, 
  #          colour = "black", size = 7, label = 'Bill Decrease')+ # bill decrease
  # annotate("point", x = 12, y = 170,
  #          colour = "#D03D0A", size = 3)+
  # annotate("text", x = 12, y = 187, 
  #          colour = "black", size = 7, label = 'Bill Increase')+ # bill decrease
  # annotate("segment", x = 11.5, xend = 11.5, y = 160, yend = 170,
  #          colour = "black", size = 1.1)+
  # annotate("text", x = 11.5, y = 193, 
  #          colour = "black", size = 7, label = 'Interquartile Range')+ # iqrange 
  # annotate("rect", xmin = 11, xmax = 13.5, ymin = 160, ymax = 215,
  #          alpha = .2)+ # rectangle
  #scale_color_manual(values = saturation(c("#0BA2DB","#D03D0A"),0.5))+
  # geom_text(data = lt10_median_percentile, 
  #           aes(x = opa_property_type, y  =bill_diff_perc_25, label = round(bill_diff_perc_25,0)),
  #           size = 6,
  #           nudge_y = -3)+
  # geom_text(data = lt10_median_percentile, 
  #           aes(x = opa_property_type, y  =bill_diff_perc_75, label = round(bill_diff_perc_75,0)),
  #           size = 6,
  #           nudge_y = 3)+
  coord_flip()+
  labs(x = '',
       y = 'Mean Absolute Percentage Error (%)',
       title = '')+
  theme_ai()+
  theme(legend.position = 'none',
        axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black"))+
  scale_y_continuous(breaks = seq(0,300,25),limits = c(0,300))

ggsave(filename = paste(Sys.Date(),'_','summary mape plot.png', sep = ''), 
       plot = mape_summary_plt,
       device = 'png',
       height = 5,
       width = 15)


#############################
# Results by primary use type
#############################

mape_summary_test<-
  mape_test %>%
  group_by(primaryspaceusage) %>%
  summarise(median_value = median(metric_value),
            perc_25_value = quantile(metric_value,.25),
            perc_75_value = quantile(metric_value,.75))

mape_summary_plt <- 
  ggplot()+
  geom_jitter(data = mape_test, aes(x = reorder(primaryspaceusage, desc(primaryspaceusage))
                                    , y = metric_value), 
              alpha = 0.4,colour='#A4A4A4' )+
  geom_point(data = mape_summary_test, aes(x = reorder(primaryspaceusage, desc(primaryspaceusage)), 
                                           y  = median_value ), size = 3.5)+
  geom_errorbar(data = mape_summary_test, aes(x = reorder(primaryspaceusage, desc(primaryspaceusage)),
                                              ymin = perc_25_value,
                                              ymax = perc_75_value), width = 0.25, size = 1.5 )+
  geom_text(data = mape_summary_test, 
            aes(x = primaryspaceusage, y  =median_value, label = round(median_value,1)),
            size = 6.5,
            nudge_x = .4)+
  # annotate("point", x = 13, y = 170,
  #          colour = "black", size = 3)+
  # annotate("text", x = 13, y = 180, 
  #          colour = "black", size = 7, label = 'Median')+ # median 
  # annotate("point", x = 12.5, y = 170,
  #          colour = "#0BA2DB", size = 3)+
  # annotate("text", x = 12.5, y = 187, 
  #          colour = "black", size = 7, label = 'Bill Decrease')+ # bill decrease
  # annotate("point", x = 12, y = 170,
  #          colour = "#D03D0A", size = 3)+
  # annotate("text", x = 12, y = 187, 
#          colour = "black", size = 7, label = 'Bill Increase')+ # bill decrease
# annotate("segment", x = 11.5, xend = 11.5, y = 160, yend = 170,
#          colour = "black", size = 1.1)+
# annotate("text", x = 11.5, y = 193, 
#          colour = "black", size = 7, label = 'Interquartile Range')+ # iqrange 
# annotate("rect", xmin = 11, xmax = 13.5, ymin = 160, ymax = 215,
#          alpha = .2)+ # rectangle
#scale_color_manual(values = saturation(c("#0BA2DB","#D03D0A"),0.5))+
# geom_text(data = lt10_median_percentile, 
#           aes(x = opa_property_type, y  =bill_diff_perc_25, label = round(bill_diff_perc_25,0)),
#           size = 6,
#           nudge_y = -3)+
# geom_text(data = lt10_median_percentile, 
#           aes(x = opa_property_type, y  =bill_diff_perc_75, label = round(bill_diff_perc_75,0)),
#           size = 6,
#           nudge_y = 3)+
coord_flip()+
  labs(x = '',
       y = 'Mean Absolute Percentage Error (%)',
       title = '')+
  theme_ai()+
  theme(legend.position = 'none',
        axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black"))+
  scale_y_continuous(breaks = seq(0,200,25),limits = c(0,200))

ggsave(filename = paste(Sys.Date(),'_','summary primary space usage mape plot.png', sep = ''), 
       plot = mape_summary_plt,
       device = 'png',
       height = 10,
       width = 20)


mape_summary_plt <- 
  ggplot()+
  geom_boxplot(data = mape_test, aes(x = reorder(primaryspaceusage, desc(primaryspaceusage))
                                    , y = metric_value, fill = primaryspaceusage), 
              alpha = 0.4)+
  # annotate("point", x = 13, y = 170,
  #          colour = "black", size = 3)+
  # annotate("text", x = 13, y = 180, 
  #          colour = "black", size = 7, label = 'Median')+ # median 
  # annotate("point", x = 12.5, y = 170,
  #          colour = "#0BA2DB", size = 3)+
  # annotate("text", x = 12.5, y = 187, 
  #          colour = "black", size = 7, label = 'Bill Decrease')+ # bill decrease
  # annotate("point", x = 12, y = 170,
  #          colour = "#D03D0A", size = 3)+
  # annotate("text", x = 12, y = 187, 
#          colour = "black", size = 7, label = 'Bill Increase')+ # bill decrease
# annotate("segment", x = 11.5, xend = 11.5, y = 160, yend = 170,
#          colour = "black", size = 1.1)+
# annotate("text", x = 11.5, y = 193, 
#          colour = "black", size = 7, label = 'Interquartile Range')+ # iqrange 
# annotate("rect", xmin = 11, xmax = 13.5, ymin = 160, ymax = 215,
#          alpha = .2)+ # rectangle
#scale_color_manual(values = saturation(c("#0BA2DB","#D03D0A"),0.5))+
# geom_text(data = lt10_median_percentile, 
#           aes(x = opa_property_type, y  =bill_diff_perc_25, label = round(bill_diff_perc_25,0)),
#           size = 6,
#           nudge_y = -3)+
# geom_text(data = lt10_median_percentile, 
#           aes(x = opa_property_type, y  =bill_diff_perc_75, label = round(bill_diff_perc_75,0)),
#           size = 6,
#           nudge_y = 3)+
coord_flip()+
  labs(x = '',
       y = 'Mean Absolute Percentage Error (%)',
       title = '')+
  theme_ai()+
  theme(legend.position = 'none')+
  scale_y_continuous(breaks = seq(0,200,25),limits = c(0,200))+
  facet_wrap(~model_type)

ggsave(filename = paste(Sys.Date(),'_','summary primary space usage mape boxplot.png', sep = ''), 
       plot = mape_summary_plt,
       device = 'png',
       height = 10,
       width = 15)

# Outputting median test set errors for each primary use type

 mape_test %>%
  group_by(primaryspaceusage,model_type) %>%
  summarise(median_value = median(metric_value),
            perc_25_value = quantile(metric_value,.25),
            perc_75_value = quantile(metric_value,.75)) %>%
   write.csv("test set error rate statistics broken down by primary use type_2020-08-12.csv")

  
  
